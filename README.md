# Triple Module Redundancy

## Licencing

Chiesel project and associated binaries (RTL and bitstream) are released with a BSD licence.
Modifications in the ultrascale linux, u-boot, zephyrOS and openOCD are released under GPL licence.

## Bitstream generation

Retrieve submodules
```
./git.sh
```

Build RTL files
```
./chiesel.sh
```

Set vivado files and launch synth/implem, you will need to have vivado sourced here. 
It has been tested with vivado 2017.4.
```
./vivado.sh
```

The resulting bitstream should be located in **TBD**


## US+ Processing system software
### Bootloaders
#### FSBL

In order to build the First Stage Boot Loader (FSBL), the Vivado Software Development Kit
is needed. The SDK is provided as part of the Vivado Design Suite. Since building the FSBL
requires a hardware description file, which is generated by Vivado during synthesis and imple-
mentation of the entire FPGA system, it’s necessary to run Vivado first. Once Vivado is done
implementing the design we can create the FSBL using the SDK’s Hardware Software Interface
tool. The steps to generate the FSBL are as follows:
1. Open the demonstrator system in Vivado
2. If you haven’t generated the bitstream before, do it now
3. Using Vivado’s export Hardware Desicription option from the File menu save the .hdf file to a known location (this can also be achieved by simply typing `write_hwdef -file demonstrator.hdf` in the tcl console inside Vivado)
4. Open the Hardware Software Interface (hsi) tool in interactive mode and type:
```Bash
generate_app -hw [open_hw_design demonstrator.hdf] -os standalone -proc ps7_cortexa53_0 -app zynqmp_fsbl -compile -sw fsbl -dir fsbl
```

#### U-Boot

Since we need to cross compile the code for ARM Cortex-A53, we will need a 64-bit ARMv8
Cortex-A cross compiler like Linaro’s aarch64-linux-gnu-gcc-linaro available on the Linaro
project’s webpage: https://releases.linaro.org/components/toolchain/gcc-linaro/latest/ Since
the base version of the bootloader used in the demonstrator system is a port done for the
Enclustra’s XU1 SoM, the same configuration can be used. Steps to perform:
1. Change the directory to the xilinx-uboot directory
2. Configure the build with:
```Bash
make CROSS_COMPILE="aarch64-none-linux-gnueabi-" ARCH=arm64 enclustra_zynqmp_mercuryxu1_defconfig
```
3. Build U-Boot with:
```Bash
make CROSS_COMPILE="aarch64-none-linux-gnueabi-" ARCH=arm64 -j(nproc)
```

### Linux kernel and risc-v-ft module
The steps to build the Linux kernel are very similar to those for U-Boot:
1. Set up the kernel build process with the xilinx_zynqmp configuration:
```Bash
make CROSS_COMPILE="aarch64-none-linux-gnueabi-" ARCH=arm64 xilinx_zynqmp_defconfig
```
2. Build the kernel:
```Bash
make CROSS_COMPILE="aarch64-none-linux-gnueabi-" ARCH=arm64 Image -j$(nproc)
```

The Image file will be available in arch/arm64/boot/ upon the completion of the compila-
tion process.

3. The risc-v-ft driver module source code is stored in the drivers/misc/antmicro direc-
tory. In the configuration from the previous step it will be compiled along with all the
Linux kernel modules once the following command is used:
```Bash
make CROSS_COMPILE="aarch64-none-linux-gnueabi-" ARCH=arm64 modules -j$(nproc)
```

## SD card generation

Now that you got the bitstream 
